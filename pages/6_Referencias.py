"""P√°gina de Biblioteca de Refer√™ncias."""
import streamlit as st
import os
from datetime import datetime
from core.reference_library import (
    search_semantic_scholar, format_abnt_citation, add_semantic_scholar_reference,
    list_local_references, search_local_references, add_local_reference,
    remove_reference, export_references_bibtex, export_references_abnt,
    get_reference_stats, clear_api_cache, get_cache_info
)
from core.theme_manager import render_theme_selector, init_theme
from core.notifications import show_toast_success, show_toast_error, show_toast_info, toast_try

# Inicializar tema
init_theme()

st.set_page_config(
    page_title="Biblioteca de Refer√™ncias",
    page_icon="üìö",
    layout="wide"
)

# Sidebar
with st.sidebar:
    st.title("üìö Biblioteca de Refer√™ncias")
    
    # Estat√≠sticas r√°pidas
    stats = get_reference_stats()
    st.metric("Total de Refer√™ncias", stats['total'])
    
    # Renderizar seletor de tema
    render_theme_selector()
    
    st.divider()
    
    # Cache management
    st.markdown("### üóÑÔ∏è Cache da API")
    cache_info = get_cache_info()
    st.caption(f"**Cache:** {cache_info['valid_entries']}/{cache_info['total_entries']} entradas v√°lidas")
    st.caption(f"**Dura√ß√£o:** {cache_info['cache_duration_hours']:.1f}h")
    
    if st.button("üßπ Limpar Cache", help="Remove todas as entradas do cache da API"):
        clear_api_cache()
        st.rerun()
    
    st.divider()

# Main content
st.title("üìö Biblioteca de Refer√™ncias")

# Tabs
tab1, tab2, tab3, tab4 = st.tabs(["üîç Pesquisar Artigos", "üìñ Minha Biblioteca", "üìã Gerar Refer√™ncias", "üìä Estat√≠sticas"])

with tab1:
    st.header("üîç Pesquisar Artigos na Semantic Scholar")
    
    col1, col2 = st.columns([3, 1])
    
    with col1:
        query = st.text_input(
            "Digite sua pesquisa:",
            placeholder="Ex: an√°lise de pre√ßos mercado bovino, beef cattle prices, econometria...",
            help="Use termos em portugu√™s ou ingl√™s para melhores resultados"
        )
    
    with col2:
        limit = st.selectbox("Limite de resultados:", [5, 10, 15, 20], index=1)
    
    # Filtros
    with st.expander("üîß Filtros Avan√ßados", expanded=False):
        col1, col2, col3 = st.columns(3)
        
        with col1:
            min_year = st.number_input("Ano m√≠nimo:", value=2000, min_value=1900, max_value=datetime.now().year)
        
        with col2:
            min_citations = st.number_input("Cita√ß√µes m√≠nimas:", value=0, min_value=0)
        
        with col3:
            fields = st.multiselect(
                "√Åreas de estudo:",
                ["Computer Science", "Economics", "Biology", "Medicine", "Mathematics", "Physics"],
                help="Deixe vazio para todas as √°reas"
            )
    
    if st.button("üîç Pesquisar", type="primary", use_container_width=True):
        if query.strip():
            try:
                results = toast_try(
                    'Pesquisando artigos',
                    lambda: search_semantic_scholar(query, limit),
                    page='referencias', action='search_semantic_scholar'
                )
                
                # Handle fallback to local references
                if results.get('fallback', False):
                    st.warning("‚ö†Ô∏è API indispon√≠vel. Mostrando refer√™ncias locais relacionadas:")
                    local_refs = search_local_references(query)
                    if local_refs:
                        for i, ref in enumerate(local_refs[:limit]):
                            with st.container():
                                st.markdown("---")
                                st.subheader(f"{i+1}. {ref.get('title', 'T√≠tulo n√£o dispon√≠vel')}")
                                st.write(f"**Cita√ß√£o ABNT:** {ref.get('citation_abnt', 'N/A')}")
                                if ref.get('authors'):
                                    st.write(f"**Autores:** {', '.join(ref.get('authors', []))}")
                                if ref.get('year'):
                                    st.write(f"**Ano:** {ref.get('year')}")
                                if ref.get('tags'):
                                    st.write(f"**Tags:** {', '.join(ref.get('tags', []))}")
                    else:
                        st.info("Nenhuma refer√™ncia local encontrada para este termo.")
                else:
                    # Handle successful API results
                    if results.get('total', 0) > 0:
                        papers = results.get('data', [])
                        st.success(f"Encontrados {len(papers)} artigos!")
                    
                        for i, paper in enumerate(papers):
                            with st.container():
                                # Filtrar por ano se especificado
                                if paper.get('year', 0) < min_year:
                                    continue
                                
                                # Filtrar por cita√ß√µes se especificado
                                if paper.get('citationCount', 0) < min_citations:
                                    continue
                                
                                # Filtrar por √°rea se especificada
                                if fields:
                                    paper_fields = paper.get('fieldsOfStudy', [])
                                    if not any(field in paper_fields for field in fields):
                                        continue
                                
                                st.markdown("---")
                                
                                # T√≠tulo
                                st.subheader(f"{i+1}. {paper.get('title', 'T√≠tulo n√£o dispon√≠vel')}")
                                
                                # Informa√ß√µes b√°sicas
                                col1, col2, col3 = st.columns([2, 1, 1])
                                
                                with col1:
                                    # Autores
                                    authors = paper.get('authors', [])
                                    if authors:
                                        author_names = [author.get('name', '') for author in authors[:3]]
                                        if len(authors) > 3:
                                            author_names.append(f"... e mais {len(authors)-3}")
                                        st.write(f"**Autores:** {', '.join(author_names)}")
                                    
                                    # Ano e venue
                                    year = paper.get('year', '')
                                    venue = paper.get('venue', '')
                                    if year and venue:
                                        st.write(f"**Publicado em:** {venue}, {year}")
                                    elif year:
                                        st.write(f"**Ano:** {year}")
                                
                                with col2:
                                    # Cita√ß√µes
                                    citations = paper.get('citationCount', 0)
                                    st.metric("Cita√ß√µes", citations)
                                
                                with col3:
                                    # √Åreas de estudo
                                    fields_of_study = paper.get('fieldsOfStudy', [])
                                    if fields_of_study:
                                        st.write(f"**√Åreas:** {', '.join(fields_of_study[:2])}")
                                
                                # Abstract
                                abstract = paper.get('abstract', '')
                                if abstract:
                                    with st.expander("üìÑ Resumo"):
                                        st.write(abstract)
                                
                                # A√ß√µes
                                col1, col2, col3, col4 = st.columns(4)
                                
                                with col1:
                                    if st.button("üìö Adicionar", key=f"add_{i}"):
                                        try:
                                            added = toast_try(
                                                'Adicionar refer√™ncia',
                                                add_semantic_scholar_reference,
                                                paper,
                                                page='referencias', action='add_semantic_ref'
                                            )
                                            if added:
                                                show_toast_success("Refer√™ncia adicionada √† biblioteca!")
                                                st.rerun()
                                            else:
                                                show_toast_error("Erro ao adicionar refer√™ncia")
                                        except Exception:
                                            pass
                                
                                with col2:
                                    # Bot√£o para baixar PDF (se dispon√≠vel)
                                    pdf_url = paper.get('openAccessPdf', {}).get('url', '') if paper.get('openAccessPdf') else ''
                                    if pdf_url:
                                        if st.button("üì• Baixar PDF", key=f"pdf_{i}"):
                                            from core.reference_library import download_pdf
                                            safe_name = (paper.get('title', 'paper') or 'paper').strip().replace(' ', '_')[:80] + ".pdf"
                                            try:
                                                ok = toast_try(
                                                    'Baixando PDF',
                                                    download_pdf,
                                                    pdf_url,
                                                    safe_name,
                                                    page='referencias', action='download_pdf'
                                                )
                                                if ok:
                                                    show_toast_success(f"PDF salvo em references/{safe_name}")
                                                else:
                                                    show_toast_error("N√£o foi poss√≠vel baixar o PDF")
                                            except Exception:
                                                pass
                                    else:
                                        st.button("üì• PDF n√£o dispon√≠vel", disabled=True, key=f"pdf_{i}")
                                
                                with col3:
                                    citation = format_abnt_citation(paper)
                                    if st.button("üìã Copiar Cita√ß√£o", key=f"copy_{i}"):
                                        st.code(citation, language=None)
                                
                                with col4:
                                    url = paper.get('url', '')
                                    if url:
                                        st.link_button("üîó Ver Original", url)
                                    else:
                                        st.button("üîó Link n√£o dispon√≠vel", disabled=True, key=f"link_{i}")
                    else:
                        st.warning("Nenhum artigo encontrado. Tente termos diferentes.")
            except Exception:
                # toast_try already logged and toasted
                pass
        else:
            st.warning("Digite um termo de pesquisa.")

with tab2:
    st.header("üìñ Minha Biblioteca")
    
    # Pesquisa local
    search_query = st.text_input("üîç Pesquisar na biblioteca:", placeholder="Digite t√≠tulo, autor ou tag...")
    
    # Carregar refer√™ncias
    if search_query:
        references = search_local_references(search_query)
        if references:
            st.success(f"Encontradas {len(references)} refer√™ncias!")
        else:
            st.info("Nenhuma refer√™ncia encontrada.")
    else:
        references = list_local_references()
        if references:
            st.info(f"Total: {len(references)} refer√™ncias na biblioteca")
        else:
            st.info("Biblioteca vazia. Adicione refer√™ncias na aba 'Pesquisar Artigos' ou fa√ßa upload de PDFs.")
    
    # Lista de refer√™ncias
    if references:
        for ref in references:
            with st.container():
                st.markdown("---")
                
                col1, col2 = st.columns([4, 1])
                
                with col1:
                    # T√≠tulo
                    st.subheader(ref.get('title', 'T√≠tulo n√£o dispon√≠vel'))
                    
                    # Informa√ß√µes
                    col_a, col_b, col_c = st.columns(3)
                    
                    with col_a:
                        authors = ref.get('authors', [])
                        if authors:
                            st.write(f"**Autores:** {', '.join(authors[:3])}")
                            if len(authors) > 3:
                                st.write(f"... e mais {len(authors)-3}")
                    
                    with col_b:
                        st.write(f"**Ano:** {ref.get('year', 'N/A')}")
                        if ref.get('venue'):
                            st.write(f"**Ve√≠culo:** {ref.get('venue', '')}")
                    
                    with col_c:
                        if ref.get('citation_count'):
                            st.metric("Cita√ß√µes", ref.get('citation_count', 0))
                        
                        # Tags
                        tags = ref.get('tags', [])
                        if tags:
                            st.write(f"**Tags:** {', '.join(tags[:3])}")
                    
                    # Cita√ß√£o ABNT
                    with st.expander("üìã Ver Cita√ß√£o ABNT"):
                        st.code(ref.get('citation_abnt', ''), language=None)
                
                with col2:
                    # A√ß√µes
                    st.write("**A√ß√µes:**")
                    
                    if st.button("üìã Copiar", key=f"copy_ref_{ref.get('id')}"):
                        st.code(ref.get('citation_abnt', ''), language=None)
                    
                    if ref.get('file') and os.path.exists(ref.get('file')):
                        if st.button("üìÑ Abrir PDF", key=f"open_{ref.get('id')}"):
                            show_toast_info("Abrindo PDF...")
                            # Placeholder: could embed PDF viewer via st.components or PyMuPDF
                    
                    if st.button("üóëÔ∏è Remover", key=f"remove_{ref.get('id')}"):
                        if remove_reference(ref.get('id')):
                            show_toast_success("Refer√™ncia removida!")
                            st.rerun()
                        else:
                            show_toast_error("Erro ao remover refer√™ncia")
    
    # Upload de PDF local
    st.divider()
    st.subheader("üì§ Adicionar PDF Local")
    
    uploaded_file = st.file_uploader(
        "Selecione um arquivo PDF:",
        type=['pdf'],
        help="Upload de PDFs para adicionar √† biblioteca"
    )
    
    if uploaded_file:
        st.success(f"Arquivo selecionado: {uploaded_file.name}")
        
        # Formul√°rio de metadados
        with st.form("metadata_form"):
            st.write("**Informa√ß√µes do documento:**")
            
            col1, col2 = st.columns(2)
            
            with col1:
                title = st.text_input("T√≠tulo:", value=uploaded_file.name.replace('.pdf', ''))
                authors_input = st.text_area("Autores (um por linha):", placeholder="Silva, Jo√£o\nSantos, Maria")
            
            with col2:
                year = st.number_input("Ano:", value=datetime.now().year, min_value=1900, max_value=datetime.now().year)
                venue = st.text_input("Ve√≠culo (Revista/Confer√™ncia):", placeholder="Revista Brasileira de Zootecnia")
            
            tags_input = st.text_input("Tags (separadas por v√≠rgula):", placeholder="mercado, bovinos, pre√ßos")
            ref_type = st.selectbox("Tipo:", ["article", "book", "thesis", "report", "other"])
            
            submitted = st.form_submit_button("üìö Adicionar √† Biblioteca", type="primary")
            
            if submitted:
                # Processar autores
                authors = [author.strip() for author in authors_input.split('\n') if author.strip()]
                
                # Processar tags
                tags = [tag.strip() for tag in tags_input.split(',') if tag.strip()]
                
                # Metadados
                metadata = {
                    'title': title,
                    'authors': authors,
                    'year': year,
                    'venue': venue,
                    'tags': tags,
                    'type': ref_type
                }
                
                # Adicionar refer√™ncia
                file_content = uploaded_file.read()
                if add_local_reference(file_content, uploaded_file.name, metadata):
                    show_toast_success("PDF adicionado √† biblioteca!")
                    st.rerun()
                else:
                    show_toast_error("Erro ao adicionar PDF")

with tab3:
    st.header("üìã Gerar Refer√™ncias")
    
    # Sele√ß√£o de refer√™ncias
    all_references = list_local_references()
    
    if all_references:
        st.write("Selecione as refer√™ncias para incluir:")
        
        # Checkbox para todas
        select_all = st.checkbox("Selecionar todas")
        
        # Lista de checkboxes
        selected_refs = []
        
        if select_all:
            selected_refs = all_references
        else:
            for ref in all_references:
                if st.checkbox(f"{ref.get('title', '')} ({ref.get('year', 'N/A')})", key=f"select_{ref.get('id')}"):
                    selected_refs.append(ref)
        
        if selected_refs:
            st.success(f"{len(selected_refs)} refer√™ncias selecionadas")
            
            # Op√ß√µes de exporta√ß√£o
            col1, col2 = st.columns(2)
            
            with col1:
                st.subheader("üìÑ Formato ABNT")
                if st.button("üìã Gerar Lista ABNT", type="primary"):
                    try:
                        abnt_list = toast_try('Gerando refer√™ncias ABNT', export_references_abnt, selected_refs, page='referencias', action='export_abnt')
                        st.code(abnt_list, language=None)
                    except Exception:
                        pass
                    
                    # Download
                    st.download_button(
                        "üíæ Baixar .txt",
                        abnt_list,
                        file_name=f"referencias_abnt_{datetime.now().strftime('%Y%m%d')}.txt",
                        mime="text/plain"
                    )
            
            with col2:
                st.subheader("üìö Formato BibTeX")
                if st.button("üìã Gerar BibTeX", type="primary"):
                    try:
                        bibtex = toast_try('Gerando BibTeX', export_references_bibtex, selected_refs, page='referencias', action='export_bibtex')
                        st.code(bibtex, language="bibtex")
                    except Exception:
                        pass
                    
                    # Download
                    st.download_button(
                        "üíæ Baixar .bib",
                        bibtex,
                        file_name=f"referencias_bibtex_{datetime.now().strftime('%Y%m%d')}.bib",
                        mime="text/plain"
                    )
            
            # Preview das refer√™ncias selecionadas
            with st.expander("üëÅÔ∏è Visualizar Refer√™ncias Selecionadas"):
                for i, ref in enumerate(selected_refs, 1):
                    st.write(f"{i}. {ref.get('citation_abnt', '')}")
        else:
            st.info("Selecione pelo menos uma refer√™ncia.")
    else:
        st.warning("Nenhuma refer√™ncia na biblioteca. Adicione refer√™ncias primeiro.")

with tab4:
    st.header("üìä Estat√≠sticas da Biblioteca")
    
    stats = get_reference_stats()
    
    if stats['total'] > 0:
        # M√©tricas principais
        col1, col2, col3, col4 = st.columns(4)
        
        with col1:
            st.metric("Total de Refer√™ncias", stats['total'])
        
        with col2:
            semantic_count = stats['by_source'].get('semantic_scholar', 0)
            st.metric("Da Semantic Scholar", semantic_count)
        
        with col3:
            local_count = stats['by_source'].get('local_upload', 0)
            st.metric("Uploads Locais", local_count)
        
        with col4:
            # Calcular ano mais recente
            if stats['by_year']:
                recent_year = max([int(year) for year in stats['by_year'].keys() if str(year).isdigit()])
                st.metric("Ano Mais Recente", recent_year)
        
        # Gr√°ficos
        col1, col2 = st.columns(2)
        
        with col1:
            st.subheader("üìä Por Fonte")
            if stats['by_source']:
                import pandas as pd
                import plotly.express as px
                
                source_df = pd.DataFrame(list(stats['by_source'].items()), columns=['Fonte', 'Quantidade'])
                fig = px.pie(source_df, values='Quantidade', names='Fonte', title="Refer√™ncias por Fonte")
                st.plotly_chart(fig, use_container_width=True)
        
        with col2:
            st.subheader("üìÖ Por Ano")
            if stats['by_year']:
                year_df = pd.DataFrame(list(stats['by_year'].items()), columns=['Ano', 'Quantidade'])
                year_df = year_df.sort_values('Ano')
                fig = px.bar(year_df, x='Ano', y='Quantidade', title="Refer√™ncias por Ano")
                st.plotly_chart(fig, use_container_width=True)
        
        # Tabela detalhada
        st.subheader("üìã Detalhamento")
        
        col1, col2 = st.columns(2)
        
        with col1:
            st.write("**Por Tipo:**")
            for ref_type, count in stats['by_type'].items():
                st.write(f"- {ref_type.title()}: {count}")
        
        with col2:
            st.write("**Por Fonte:**")
            for source, count in stats['by_source'].items():
                source_name = "Semantic Scholar" if source == "semantic_scholar" else "Upload Local"
                st.write(f"- {source_name}: {count}")
    else:
        st.info("Nenhuma refer√™ncia na biblioteca ainda.")
        
        # Sugest√µes
        st.subheader("üí° Como come√ßar:")
        st.write("1. üìö V√° para a aba 'Pesquisar Artigos' e encontre artigos relevantes")
        st.write("2. üì§ Fa√ßa upload de PDFs locais na aba 'Minha Biblioteca'")
        st.write("3. üìã Use a aba 'Gerar Refer√™ncias' para criar listas de refer√™ncias")

# Footer
st.divider()
st.caption("üí° Dica: Use a pesquisa da Semantic Scholar para encontrar artigos acad√™micos relevantes e adicione-os √† sua biblioteca pessoal.")